# API 连通性测试脚本

本目录包含用于测试 AgriVerse 后端 API 连通性的测试脚本。

## 文件说明

- `test-api.sh` - Linux/Mac 测试脚本（使用 Bash）
- `test-api.bat` - Windows 测试脚本（使用 Batch）
- `README.md` - 本说明文件

## 前置条件

1. **后端服务已启动**
   - 确保后端服务运行在 `http://localhost:8080`
   - 或者修改脚本中的 `BASE_URL` 变量

2. **安装 curl**
   - Linux/Mac: 通常已预装，如果没有请安装：`sudo apt-get install curl` 或 `brew install curl`
   - Windows: 需要安装 curl，Windows 10 1803+ 已内置，或下载 [curl for Windows](https://curl.se/windows/)

## 使用方法

### Linux/Mac

```bash
# 1. 添加执行权限
chmod +x test-api.sh

# 2. 运行测试（使用默认地址 http://localhost:8080/api）
./test-api.sh

# 3. 或指定自定义地址
./test-api.sh http://192.168.1.100:8080/api
```

### Windows

```cmd
# 1. 直接运行（使用默认地址 http://localhost:8080/api）
test-api.bat

# 2. 或指定自定义地址
test-api.bat http://192.168.1.100:8080/api
```

## 测试内容

脚本会依次测试以下功能：

1. **健康检查**
   - 认证服务健康检查 (`/auth/health`)
   - 农户商品服务健康检查 (`/farmer/products/health`)

2. **用户注册**
   - 测试用户注册接口 (`/auth/register`)
   - 使用随机生成的手机号避免重复

3. **用户登录**
   - 测试用户登录接口 (`/auth/login`)
   - 获取 JWT Token 用于后续测试

4. **认证接口**
   - 测试获取当前用户信息 (`/auth/me`)
   - 验证 JWT Token 是否有效

5. **农户商品管理接口**
   - 获取商品列表 (`/farmer/products/list`)
   - 获取已上架商品列表（带筛选）
   - 搜索商品（带搜索关键词）
   - 获取商品数据看板 (`/farmer/products/dashboard`)

6. **安全测试**
   - 测试未认证访问受保护接口
   - 验证是否正确返回 401 未授权错误

## 测试结果

脚本运行完成后会显示：

- ✓ 通过的测试数量
- ✗ 失败的测试数量
- 成功率百分比

### 示例输出

```
==========================================
测试结果汇总
==========================================
通过: 8
失败: 0
成功率: 100%

所有测试通过！✓
```

## 故障排查

### 问题：连接被拒绝

**错误信息**: `curl: (7) Failed to connect to localhost port 8080`

**解决方案**:
1. 检查后端服务是否已启动
2. 检查端口是否正确（默认 8080）
3. 检查防火墙设置

### 问题：401 未授权

**错误信息**: `HTTP 401`

**可能原因**:
1. Token 已过期
2. Token 格式不正确
3. 用户登录失败

**解决方案**:
1. 检查后端日志
2. 确认 JWT 配置正确
3. 重新运行测试脚本

### 问题：404 未找到

**错误信息**: `HTTP 404`

**可能原因**:
1. API 路径不正确
2. 后端服务未正确部署

**解决方案**:
1. 检查 `application.yml` 中的 `context-path` 配置
2. 确认 Controller 的 `@RequestMapping` 路径

### 问题：500 服务器错误

**错误信息**: `HTTP 500`

**可能原因**:
1. 数据库连接失败
2. 服务内部错误

**解决方案**:
1. 检查后端日志
2. 确认数据库配置正确
3. 检查数据库是否已创建

## 注意事项

1. **测试数据**: 脚本会创建测试用户，使用随机手机号避免冲突
2. **Token 有效期**: 测试使用的 Token 有效期为 24 小时
3. **数据库**: 确保数据库已正确配置，否则部分测试可能失败
4. **网络**: 确保测试机器可以访问后端服务地址

## 扩展测试

如果需要添加更多测试用例，可以：

1. 在脚本中添加新的测试函数
2. 参考现有测试函数的格式
3. 确保正确处理认证 Token

## 相关文档

- [后端 README](../README.md) - 完整的后端文档
- [API 文档](../README.md#api-接口文档) - API 接口详细说明

